# 山西电网智能报告系统 - 部署指南

## 1. 部署概述

本系统采用现代化的云原生架构，前端部署在 Vercel，后端使用 Supabase，支持快速部署和弹性扩缩容。

### 1.1 技术栈
- **前端**: React + TypeScript + Vite
- **后端**: Supabase (PostgreSQL + Edge Functions)
- **AI服务**: 多厂商API集成
- **部署**: Vercel + Supabase Cloud

## 2. 环境准备

### 2.1 开发环境要求
- Node.js >= 18.0.0
- npm >= 8.0.0 或 yarn >= 1.22.0
- Git

### 2.2 账号准备
- [Supabase](https://supabase.com) 账号
- [Vercel](https://vercel.com) 账号
- AI服务提供商账号（阿里云、Moonshot、智谱、DeepSeek、Google）

## 3. Supabase 后端部署

### 3.1 创建 Supabase 项目

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 点击 "New Project" 创建新项目
3. 填写项目信息：
   - **Name**: `smart-report-sx`
   - **Database Password**: 设置强密码
   - **Region**: 选择 `Northeast Asia (Tokyo)` 或最近的区域

### 3.2 配置数据库

1. 在项目 Dashboard 中，进入 "SQL Editor"
2. 执行数据库迁移脚本：
   ```sql
   -- 复制 supabase/migrations/001_initial_schema.sql 的内容并执行
   ```

### 3.3 配置认证

1. 进入 "Authentication" > "Settings"
2. 配置认证设置：
   - **Site URL**: `https://your-domain.vercel.app`
   - **Redirect URLs**: 添加生产环境域名

### 3.4 配置存储

1. 进入 "Storage"
2. 创建存储桶：
   - **Name**: `data-files`
   - **Public**: false
   - **File size limit**: 100MB

### 3.5 获取环境变量

在 "Settings" > "API" 中获取：
- **Project URL**: `VITE_SUPABASE_URL`
- **anon public key**: `VITE_SUPABASE_ANON_KEY`
- **service_role secret**: `SUPABASE_SERVICE_ROLE_KEY`

## 4. AI 服务配置

### 4.1 阿里千问 (通义千问)

1. 登录 [阿里云控制台](https://dashscope.console.aliyun.com/)
2. 开通 "通义千问" 服务
3. 创建 API Key
4. 配置环境变量：`VITE_QWEN_API_KEY`

### 4.2 Moonshot AI (Kimi)

1. 登录 [Moonshot AI 平台](https://platform.moonshot.cn/)
2. 创建 API Key
3. 配置环境变量：`VITE_KIMI_API_KEY`

### 4.3 智谱 GLM

1. 登录 [智谱AI开放平台](https://open.bigmodel.cn/)
2. 创建 API Key
3. 配置环境变量：`VITE_ZHIPU_API_KEY`

### 4.4 DeepSeek

1. 登录 [DeepSeek 平台](https://platform.deepseek.com/)
2. 创建 API Key
3. 配置环境变量：`VITE_DEEPSEEK_API_KEY`

### 4.5 Google Gemini

1. 登录 [Google AI Studio](https://makersuite.google.com/)
2. 创建 API Key
3. 配置环境变量：`VITE_GEMINI_API_KEY`

## 5. 前端部署 (Vercel)

### 5.1 连接 GitHub 仓库

1. 将代码推送到 GitHub 仓库
2. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
3. 点击 "New Project"
4. 选择 GitHub 仓库并导入

### 5.2 配置环境变量

在 Vercel 项目设置中添加环境变量：

```bash
# Supabase 配置
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# AI 服务配置
VITE_QWEN_API_KEY=sk-7c12945ced9d4c7babbb4ca7f661d055
VITE_KIMI_API_KEY=sk-WZQkZ6W8E47DkB8uATaey76Deo09lht0nJmA6wRugPvI0Gmr
VITE_ZHIPU_API_KEY=105722980eb8400491bfe3a56c63f13a.NnceHUU3NlhCK55m
VITE_DEEPSEEK_API_KEY=sk-58ef49264a7e416c896b8ce12d4b2f04
VITE_GEMINI_API_KEY=AIzaSyDtK7fq5OQCl7_dOWuI6F6TJZIpKUsa2ho

# 应用配置
VITE_APP_NAME=山西电网智能报告系统
VITE_APP_VERSION=1.0.0
VITE_APP_ENV=production
```

### 5.3 配置构建设置

- **Framework Preset**: Vite
- **Build Command**: `npm run build`
- **Output Directory**: `dist`
- **Install Command**: `npm install`

### 5.4 配置自定义域名（可选）

1. 在 Vercel 项目设置中进入 "Domains"
2. 添加自定义域名
3. 配置 DNS 记录

## 6. 本地开发环境

### 6.1 克隆项目

```bash
git clone https://github.com/your-username/smart-report.git
cd smart-report
```

### 6.2 安装依赖

```bash
npm install
```

### 6.3 配置环境变量

复制环境变量模板：
```bash
cp .env.example .env
```

编辑 `.env` 文件，填入实际的配置值。

### 6.4 启动开发服务器

```bash
npm run dev
```

访问 `http://localhost:5173` 查看应用。

## 7. 生产环境优化

### 7.1 性能优化

- **代码分割**: 已配置路由级别的懒加载
- **资源压缩**: Vite 自动处理
- **CDN 缓存**: Vercel 自动配置
- **图片优化**: 使用 WebP 格式

### 7.2 安全配置

- **HTTPS**: Vercel 自动配置 SSL
- **CSP**: 已配置内容安全策略
- **CORS**: Supabase 自动处理
- **API 密钥**: 使用环境变量管理

### 7.3 监控配置

- **错误监控**: 可集成 Sentry
- **性能监控**: Vercel Analytics
- **日志监控**: Supabase Logs

## 8. 部署流程

### 8.1 自动部署

1. 推送代码到 `main` 分支
2. Vercel 自动触发构建和部署
3. 部署完成后自动更新生产环境

### 8.2 手动部署

```bash
# 构建项目
npm run build

# 使用 Vercel CLI 部署
npx vercel --prod
```

### 8.3 回滚部署

1. 在 Vercel Dashboard 中查看部署历史
2. 选择要回滚的版本
3. 点击 "Promote to Production"

## 9. 故障排除

### 9.1 常见问题

#### 构建失败
- 检查 Node.js 版本是否符合要求
- 检查环境变量是否正确配置
- 查看构建日志中的错误信息

#### API 调用失败
- 检查 Supabase 项目状态
- 验证 API 密钥是否有效
- 检查网络连接和防火墙设置

#### AI 服务调用失败
- 验证 AI API 密钥是否有效
- 检查 API 配额是否用完
- 查看 AI 服务状态页面

### 9.2 日志查看

- **Vercel 日志**: 在 Vercel Dashboard 的 "Functions" 标签页
- **Supabase 日志**: 在 Supabase Dashboard 的 "Logs" 标签页
- **浏览器日志**: 使用开发者工具查看控制台

### 9.3 性能问题

- 使用 Lighthouse 分析性能
- 检查网络请求是否过多
- 优化图片和资源加载

## 10. 维护和更新

### 10.1 定期维护

- 每月检查依赖包更新
- 定期备份 Supabase 数据
- 监控 API 使用量和成本
- 检查安全漏洞和补丁

### 10.2 版本更新

1. 在开发分支进行功能开发
2. 通过 Pull Request 进行代码审查
3. 合并到 `main` 分支触发自动部署
4. 验证生产环境功能正常

### 10.3 数据库迁移

```sql
-- 创建新的迁移文件
-- supabase/migrations/002_feature_update.sql

-- 在 Supabase SQL Editor 中执行迁移
```

## 11. 成本优化

### 11.1 Vercel 成本
- **Hobby 计划**: 免费，适合开发和小规模使用
- **Pro 计划**: $20/月，适合生产环境

### 11.2 Supabase 成本
- **Free 计划**: 免费，包含 500MB 数据库
- **Pro 计划**: $25/月，包含 8GB 数据库

### 11.3 AI 服务成本
- 根据实际使用量付费
- 建议设置使用限额和预警
- 定期审查 API 调用统计

## 12. 安全最佳实践

### 12.1 API 密钥管理
- 使用环境变量存储敏感信息
- 定期轮换 API 密钥
- 不要在代码中硬编码密钥

### 12.2 数据安全
- 启用 Supabase 行级安全 (RLS)
- 定期备份重要数据
- 使用 HTTPS 传输数据

### 12.3 访问控制
- 实施最小权限原则
- 定期审查用户权限
- 启用多因素认证

---

## 联系支持

如果在部署过程中遇到问题，请联系技术支持团队或查看以下资源：

- **项目文档**: `/docs` 目录
- **Vercel 文档**: https://vercel.com/docs
- **Supabase 文档**: https://supabase.com/docs
- **技术支持**: support@your-domain.com

**部署成功后，请访问生产环境 URL 验证所有功能正常运行。**