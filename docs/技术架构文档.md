# å±±è¥¿ç”µç½‘æ™ºèƒ½æŠ¥å‘Šç³»ç»Ÿ - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1. æŠ€æœ¯æ¶æ„æ¦‚è¿°

### 1.1 æ¶æ„è®¾è®¡åŸåˆ™
- **å¾®æœåŠ¡æ¶æ„**: æ¨¡å—åŒ–è®¾è®¡ï¼ŒæœåŠ¡ç‹¬ç«‹éƒ¨ç½²
- **äº‘åŸç”Ÿ**: åŸºäºäº‘å¹³å°ï¼Œæ”¯æŒå¼¹æ€§æ‰©ç¼©å®¹
- **é«˜å¯ç”¨**: å¤šå±‚å®¹é”™æœºåˆ¶ï¼Œä¿éšœç³»ç»Ÿç¨³å®šæ€§
- **å®‰å…¨ä¼˜å…ˆ**: å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨
- **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜ç­–ç•¥å’Œå¼‚æ­¥å¤„ç†æå‡æ€§èƒ½

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

#### 1.2.1 å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: React 18 + TypeScript
- **æ„å»ºå·¥å…·**: Vite
- **UIç»„ä»¶åº“**: Ant Design
- **çŠ¶æ€ç®¡ç†**: React Context + Hooks
- **è·¯ç”±**: React Router v6
- **åŠ¨ç”»**: Framer Motion
- **æ ·å¼**: Tailwind CSS + CSS Modules

#### 1.2.2 åç«¯æŠ€æœ¯æ ˆ
- **æ•°æ®åº“**: Supabase (PostgreSQL)
- **è®¤è¯**: Supabase Auth
- **API**: Supabase REST API + Edge Functions
- **æ–‡ä»¶å­˜å‚¨**: Supabase Storage
- **å®æ—¶é€šä¿¡**: Supabase Realtime

#### 1.2.3 AIæœåŠ¡é›†æˆ
- **é˜¿é‡Œåƒé—®**: é€šä¹‰åƒé—®API
- **Kimi**: Moonshot AI API
- **æ™ºè°±**: GLM API
- **DeepSeek**: DeepSeek API
- **Gemini**: Google Gemini API

#### 1.2.4 éƒ¨ç½²ä¸è¿ç»´
- **å®¹å™¨åŒ–**: Docker
- **éƒ¨ç½²å¹³å°**: Vercel (å‰ç«¯) + Supabase (åç«¯)
- **ç›‘æ§**: Supabase Analytics + è‡ªå®šä¹‰ç›‘æ§
- **æ—¥å¿—**: Supabase Logs

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·å±‚"
        U1[Webæµè§ˆå™¨]
        U2[ç§»åŠ¨è®¾å¤‡]
    end
    
    subgraph "CDNå±‚"
        CDN[Vercel CDN]
    end
    
    subgraph "å‰ç«¯å±‚"
        FE[Reactåº”ç”¨]
        FE --> |é™æ€èµ„æº| CDN
    end
    
    subgraph "APIç½‘å…³å±‚"
        AG[Supabase API Gateway]
    end
    
    subgraph "ä¸šåŠ¡æœåŠ¡å±‚"
        AS[è®¤è¯æœåŠ¡]
        DS[æ•°æ®æœåŠ¡]
        AIS[AIåˆ†ææœåŠ¡]
        RS[æŠ¥å‘ŠæœåŠ¡]
        MS[ç›‘æ§æœåŠ¡]
    end
    
    subgraph "AIæœåŠ¡å±‚"
        AI1[é˜¿é‡Œåƒé—®]
        AI2[Kimi]
        AI3[æ™ºè°±GLM]
        AI4[DeepSeek]
        AI5[Gemini]
    end
    
    subgraph "æ•°æ®å±‚"
        DB[(Supabase PostgreSQL)]
        FS[Supabase Storage]
        CACHE[Redisç¼“å­˜]
    end
    
    subgraph "å¤–éƒ¨æ•°æ®æº"
        EDS1[ç”µç½‘æ•°æ®åº“]
        EDS2[Excelæ–‡ä»¶]
        EDS3[å®æ—¶API]
    end
    
    U1 --> CDN
    U2 --> CDN
    CDN --> FE
    FE --> AG
    AG --> AS
    AG --> DS
    AG --> AIS
    AG --> RS
    AG --> MS
    
    AIS --> AI1
    AIS --> AI2
    AIS --> AI3
    AIS --> AI4
    AIS --> AI5
    
    AS --> DB
    DS --> DB
    RS --> DB
    MS --> DB
    
    DS --> FS
    RS --> FS
    
    DS --> CACHE
    AIS --> CACHE
    
    DS --> EDS1
    DS --> EDS2
    DS --> EDS3
```

### 2.2 æœåŠ¡æ¶æ„è®¾è®¡

#### 2.2.1 è®¤è¯æœåŠ¡ (Auth Service)
- **èŒè´£**: ç”¨æˆ·è®¤è¯ã€æˆæƒã€ä¼šè¯ç®¡ç†
- **æŠ€æœ¯å®ç°**: Supabase Auth + JWT
- **å…³é”®åŠŸèƒ½**:
  - ç”¨æˆ·æ³¨å†Œ/ç™»å½•
  - å¤šå› ç´ è®¤è¯
  - è§’è‰²æƒé™ç®¡ç†
  - ä¼šè¯çŠ¶æ€ç®¡ç†

#### 2.2.2 æ•°æ®æœåŠ¡ (Data Service)
- **èŒè´£**: æ•°æ®æºç®¡ç†ã€æ•°æ®å¤„ç†ã€æ•°æ®å­˜å‚¨
- **æŠ€æœ¯å®ç°**: Supabase Edge Functions + PostgreSQL
- **å…³é”®åŠŸèƒ½**:
  - æ•°æ®æºè¿æ¥ç®¡ç†
  - æ•°æ®è´¨é‡æ£€æŸ¥
  - æ•°æ®é¢„å¤„ç†
  - æ•°æ®å­˜å‚¨ä¼˜åŒ–

#### 2.2.3 AIåˆ†ææœåŠ¡ (AI Analysis Service)
- **èŒè´£**: AIæ¨¡å‹è°ƒç”¨ã€åˆ†æä»»åŠ¡ç®¡ç†ã€ç»“æœå¤„ç†
- **æŠ€æœ¯å®ç°**: Edge Functions + å¤šAI APIé›†æˆ
- **å…³é”®åŠŸèƒ½**:
  - æ™ºèƒ½ä½“åä½œè°ƒåº¦
  - AI APIè´Ÿè½½å‡è¡¡
  - åˆ†æä»»åŠ¡é˜Ÿåˆ—
  - ç»“æœç¼“å­˜ä¼˜åŒ–

#### 2.2.4 æŠ¥å‘ŠæœåŠ¡ (Report Service)
- **èŒè´£**: æŠ¥å‘Šæ¨¡æ¿ç®¡ç†ã€æŠ¥å‘Šç”Ÿæˆã€æŠ¥å‘Šå‘å¸ƒ
- **æŠ€æœ¯å®ç°**: Edge Functions + æ¨¡æ¿å¼•æ“
- **å…³é”®åŠŸèƒ½**:
  - æ¨¡æ¿æ¸²æŸ“å¼•æ“
  - æŠ¥å‘Šç‰ˆæœ¬ç®¡ç†
  - å¤šæ ¼å¼å¯¼å‡º
  - æƒé™æ§åˆ¶

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 æ•°æ®åº“æ¶æ„

#### 3.1.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(200),
    avatar_url TEXT,
    role_id UUID REFERENCES roles(id),
    organization_id UUID REFERENCES organizations(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    permissions JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç»„ç»‡è¡¨
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    parent_id UUID REFERENCES organizations(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ•°æ®æºè¡¨
CREATE TABLE data_sources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    type VARCHAR(50) NOT NULL, -- 'database', 'file', 'api'
    connection_config JSONB,
    status VARCHAR(20) DEFAULT 'active', -- 'active', 'inactive', 'error'
    owner_id UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ•°æ®é›†è¡¨
CREATE TABLE datasets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID REFERENCES data_sources(id),
    name VARCHAR(200) NOT NULL,
    schema_definition JSONB,
    row_count BIGINT,
    size_bytes BIGINT,
    quality_score DECIMAL(3,2),
    last_updated TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ†æä»»åŠ¡è¡¨
CREATE TABLE analysis_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    data_source_id UUID REFERENCES data_sources(id),
    analysis_type VARCHAR(50) NOT NULL,
    parameters JSONB,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'running', 'completed', 'failed'
    progress INTEGER DEFAULT 0,
    owner_id UUID REFERENCES users(id),
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ†æç»“æœè¡¨
CREATE TABLE analysis_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES analysis_tasks(id),
    result_data JSONB,
    insights JSONB,
    visualizations JSONB,
    confidence_score DECIMAL(3,2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æŠ¥å‘Šæ¨¡æ¿è¡¨
CREATE TABLE report_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    template_type VARCHAR(50),
    content JSONB,
    parameters JSONB,
    is_public BOOLEAN DEFAULT false,
    owner_id UUID REFERENCES users(id),
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æŠ¥å‘Šå®ä¾‹è¡¨
CREATE TABLE reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID REFERENCES report_templates(id),
    title VARCHAR(300) NOT NULL,
    content JSONB,
    status VARCHAR(20) DEFAULT 'draft', -- 'draft', 'published', 'archived'
    owner_id UUID REFERENCES users(id),
    published_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- AIé…ç½®è¡¨
CREATE TABLE ai_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    provider VARCHAR(50) NOT NULL, -- 'qwen', 'kimi', 'zhipu', 'deepseek', 'gemini'
    api_key_encrypted TEXT NOT NULL,
    endpoint_url TEXT,
    model_name VARCHAR(100),
    parameters JSONB,
    is_active BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç³»ç»Ÿæ—¥å¿—è¡¨
CREATE TABLE system_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    level VARCHAR(20) NOT NULL, -- 'info', 'warn', 'error', 'debug'
    service VARCHAR(50),
    message TEXT,
    metadata JSONB,
    user_id UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3.1.2 ç´¢å¼•è®¾è®¡

```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role_org ON users(role_id, organization_id);
CREATE INDEX idx_data_sources_owner ON data_sources(owner_id);
CREATE INDEX idx_data_sources_type_status ON data_sources(type, status);
CREATE INDEX idx_analysis_tasks_owner_status ON analysis_tasks(owner_id, status);
CREATE INDEX idx_analysis_tasks_created_at ON analysis_tasks(created_at DESC);
CREATE INDEX idx_reports_owner_status ON reports(owner_id, status);
CREATE INDEX idx_system_logs_level_created ON system_logs(level, created_at DESC);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_reports_title_search ON reports USING gin(to_tsvector('english', title));
CREATE INDEX idx_templates_name_search ON report_templates USING gin(to_tsvector('english', name));
```

### 3.2 æ•°æ®å®‰å…¨è®¾è®¡

#### 3.2.1 è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE data_sources ENABLE ROW LEVEL SECURITY;
ALTER TABLE analysis_tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own profile" ON users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON users
    FOR UPDATE USING (auth.uid() = id);

-- æ•°æ®æºè®¿é—®ç­–ç•¥
CREATE POLICY "Users can view own data sources" ON data_sources
    FOR SELECT USING (owner_id = auth.uid());

CREATE POLICY "Users can manage own data sources" ON data_sources
    FOR ALL USING (owner_id = auth.uid());

-- åˆ†æä»»åŠ¡è®¿é—®ç­–ç•¥
CREATE POLICY "Users can view own analysis tasks" ON analysis_tasks
    FOR SELECT USING (owner_id = auth.uid());

CREATE POLICY "Users can manage own analysis tasks" ON analysis_tasks
    FOR ALL USING (owner_id = auth.uid());

-- æŠ¥å‘Šè®¿é—®ç­–ç•¥
CREATE POLICY "Users can view accessible reports" ON reports
    FOR SELECT USING (
        owner_id = auth.uid() OR 
        status = 'published'
    );

CREATE POLICY "Users can manage own reports" ON reports
    FOR ALL USING (owner_id = auth.uid());
```

#### 3.2.2 æ•°æ®åŠ å¯†

```sql
-- åˆ›å»ºåŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_api_key(api_key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(encrypt(api_key::bytea, 'encryption_key', 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION decrypt_api_key(encrypted_key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_key, 'base64'), 'encryption_key', 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 4. APIè®¾è®¡è§„èŒƒ

### 4.1 RESTful APIè®¾è®¡

#### 4.1.1 APIåŸºç¡€è§„èŒƒ

```
åŸºç¡€URL: https://your-project.supabase.co/rest/v1/
è®¤è¯æ–¹å¼: Bearer Token (JWT)
å†…å®¹ç±»å‹: application/json
å­—ç¬¦ç¼–ç : UTF-8
```

#### 4.1.2 å“åº”æ ¼å¼æ ‡å‡†

```json
// æˆåŠŸå“åº”
{
  "success": true,
  "data": {
    // å“åº”æ•°æ®
  },
  "message": "æ“ä½œæˆåŠŸ",
  "timestamp": "2024-01-15T10:30:00Z"
}

// é”™è¯¯å“åº”
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "å‚æ•°éªŒè¯å¤±è´¥",
    "details": {
      "field": "email",
      "reason": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
    }
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### 4.1.3 æ ¸å¿ƒAPIç«¯ç‚¹

##### ç”¨æˆ·ç®¡ç†API

```
# ç”¨æˆ·è®¤è¯
POST /auth/signup          # ç”¨æˆ·æ³¨å†Œ
POST /auth/signin          # ç”¨æˆ·ç™»å½•
POST /auth/signout         # ç”¨æˆ·ç™»å‡º
POST /auth/refresh         # åˆ·æ–°ä»¤ç‰Œ
POST /auth/reset-password  # é‡ç½®å¯†ç 

# ç”¨æˆ·ä¿¡æ¯
GET    /users/profile      # è·å–ç”¨æˆ·ä¿¡æ¯
PUT    /users/profile      # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
GET    /users/permissions  # è·å–ç”¨æˆ·æƒé™
```

##### æ•°æ®æºç®¡ç†API

```
# æ•°æ®æºCRUD
GET    /data-sources           # è·å–æ•°æ®æºåˆ—è¡¨
POST   /data-sources           # åˆ›å»ºæ•°æ®æº
GET    /data-sources/{id}      # è·å–æ•°æ®æºè¯¦æƒ…
PUT    /data-sources/{id}      # æ›´æ–°æ•°æ®æº
DELETE /data-sources/{id}      # åˆ é™¤æ•°æ®æº

# æ•°æ®æºæ“ä½œ
POST   /data-sources/{id}/test-connection  # æµ‹è¯•è¿æ¥
GET    /data-sources/{id}/schema           # è·å–æ•°æ®ç»“æ„
POST   /data-sources/{id}/preview          # é¢„è§ˆæ•°æ®
POST   /data-sources/upload               # æ–‡ä»¶ä¸Šä¼ 
```

##### AIåˆ†æAPI

```
# åˆ†æä»»åŠ¡
GET    /analysis/tasks        # è·å–åˆ†æä»»åŠ¡åˆ—è¡¨
POST   /analysis/tasks        # åˆ›å»ºåˆ†æä»»åŠ¡
GET    /analysis/tasks/{id}   # è·å–ä»»åŠ¡è¯¦æƒ…
PUT    /analysis/tasks/{id}   # æ›´æ–°ä»»åŠ¡
DELETE /analysis/tasks/{id}   # åˆ é™¤ä»»åŠ¡

# ä»»åŠ¡æ‰§è¡Œ
POST   /analysis/tasks/{id}/start   # å¯åŠ¨åˆ†æ
POST   /analysis/tasks/{id}/stop    # åœæ­¢åˆ†æ
GET    /analysis/tasks/{id}/status  # è·å–æ‰§è¡ŒçŠ¶æ€
GET    /analysis/tasks/{id}/result  # è·å–åˆ†æç»“æœ

# AIæœåŠ¡
GET    /analysis/ai-services        # è·å–AIæœåŠ¡çŠ¶æ€
POST   /analysis/ai-services/test   # æµ‹è¯•AIæœåŠ¡
```

##### æŠ¥å‘Šç®¡ç†API

```
# æŠ¥å‘Šæ¨¡æ¿
GET    /reports/templates        # è·å–æ¨¡æ¿åˆ—è¡¨
POST   /reports/templates        # åˆ›å»ºæ¨¡æ¿
GET    /reports/templates/{id}   # è·å–æ¨¡æ¿è¯¦æƒ…
PUT    /reports/templates/{id}   # æ›´æ–°æ¨¡æ¿
DELETE /reports/templates/{id}   # åˆ é™¤æ¨¡æ¿

# æŠ¥å‘Šå®ä¾‹
GET    /reports               # è·å–æŠ¥å‘Šåˆ—è¡¨
POST   /reports               # åˆ›å»ºæŠ¥å‘Š
GET    /reports/{id}          # è·å–æŠ¥å‘Šè¯¦æƒ…
PUT    /reports/{id}          # æ›´æ–°æŠ¥å‘Š
DELETE /reports/{id}          # åˆ é™¤æŠ¥å‘Š

# æŠ¥å‘Šæ“ä½œ
POST   /reports/{id}/publish    # å‘å¸ƒæŠ¥å‘Š
POST   /reports/{id}/export     # å¯¼å‡ºæŠ¥å‘Š
GET    /reports/{id}/versions   # è·å–ç‰ˆæœ¬å†å²
```

### 4.2 Edge Functionsè®¾è®¡

#### 4.2.1 AIåˆ†æå‡½æ•°

```typescript
// supabase/functions/ai-analysis/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

interface AnalysisRequest {
  taskId: string
  dataSourceId: string
  analysisType: string
  parameters: Record<string, any>
}

serve(async (req) => {
  try {
    const { taskId, dataSourceId, analysisType, parameters }: AnalysisRequest = await req.json()
    
    // è·å–æ•°æ®
    const data = await fetchDataFromSource(dataSourceId)
    
    // AIåˆ†ææµç¨‹
    const analysisResult = await performAIAnalysis({
      data,
      type: analysisType,
      parameters
    })
    
    // ä¿å­˜ç»“æœ
    await saveAnalysisResult(taskId, analysisResult)
    
    return new Response(
      JSON.stringify({ success: true, result: analysisResult }),
      { headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ success: false, error: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})

async function performAIAnalysis(config: any) {
  // æ™ºèƒ½ä½“åä½œåˆ†æé€»è¾‘
  const agents = [
    new DataCollectionAgent(),
    new PatternRecognitionAgent(),
    new PredictiveModelingAgent(),
    new AnomalyDetectionAgent(),
    new ReportGenerationAgent()
  ]
  
  let result = config.data
  for (const agent of agents) {
    result = await agent.process(result, config.parameters)
  }
  
  return result
}
```

#### 4.2.2 æŠ¥å‘Šç”Ÿæˆå‡½æ•°

```typescript
// supabase/functions/report-generation/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

interface ReportRequest {
  templateId: string
  data: Record<string, any>
  format: 'html' | 'pdf' | 'docx'
}

serve(async (req) => {
  try {
    const { templateId, data, format }: ReportRequest = await req.json()
    
    // è·å–æ¨¡æ¿
    const template = await getReportTemplate(templateId)
    
    // æ¸²æŸ“æŠ¥å‘Š
    const report = await renderReport(template, data)
    
    // æ ¼å¼è½¬æ¢
    const output = await convertFormat(report, format)
    
    return new Response(output, {
      headers: {
        'Content-Type': getContentType(format),
        'Content-Disposition': `attachment; filename="report.${format}"`
      }
    })
  } catch (error) {
    return new Response(
      JSON.stringify({ success: false, error: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

## 5. AIæœåŠ¡é›†æˆæ¶æ„

### 5.1 AIæœåŠ¡æŠ½è±¡å±‚

```typescript
// src/services/ai/AIServiceManager.ts
export interface AIProvider {
  name: string
  endpoint: string
  apiKey: string
  model: string
  priority: number
  isActive: boolean
}

export interface AIRequest {
  prompt: string
  context?: string
  parameters?: Record<string, any>
}

export interface AIResponse {
  content: string
  usage: {
    promptTokens: number
    completionTokens: number
    totalTokens: number
  }
  model: string
  provider: string
}

export class AIServiceManager {
  private providers: AIProvider[] = []
  private loadBalancer: LoadBalancer
  private fallbackManager: FallbackManager
  
  constructor() {
    this.loadBalancer = new LoadBalancer()
    this.fallbackManager = new FallbackManager()
    this.initializeProviders()
  }
  
  async callAI(request: AIRequest): Promise<AIResponse> {
    const provider = this.loadBalancer.selectProvider(this.providers)
    
    try {
      return await this.makeRequest(provider, request)
    } catch (error) {
      return await this.fallbackManager.handleFailure(provider, request, this.providers)
    }
  }
  
  private async makeRequest(provider: AIProvider, request: AIRequest): Promise<AIResponse> {
    switch (provider.name) {
      case 'qwen':
        return await this.callQwen(provider, request)
      case 'kimi':
        return await this.callKimi(provider, request)
      case 'zhipu':
        return await this.callZhipu(provider, request)
      case 'deepseek':
        return await this.callDeepSeek(provider, request)
      case 'gemini':
        return await this.callGemini(provider, request)
      default:
        throw new Error(`Unsupported provider: ${provider.name}`)
    }
  }
}
```

### 5.2 è´Ÿè½½å‡è¡¡ç­–ç•¥

```typescript
// src/services/ai/LoadBalancer.ts
export class LoadBalancer {
  private requestCounts: Map<string, number> = new Map()
  private lastUsed: Map<string, number> = new Map()
  
  selectProvider(providers: AIProvider[]): AIProvider {
    const activeProviders = providers.filter(p => p.isActive)
    
    if (activeProviders.length === 0) {
      throw new Error('No active AI providers available')
    }
    
    // ä¼˜å…ˆçº§ + è½®è¯¢ç­–ç•¥
    const highPriorityProviders = activeProviders.filter(p => p.priority === 1)
    
    if (highPriorityProviders.length > 0) {
      return this.roundRobin(highPriorityProviders)
    }
    
    return this.roundRobin(activeProviders)
  }
  
  private roundRobin(providers: AIProvider[]): AIProvider {
    // é€‰æ‹©æœ€å°‘ä½¿ç”¨çš„æä¾›å•†
    return providers.reduce((least, current) => {
      const leastCount = this.requestCounts.get(least.name) || 0
      const currentCount = this.requestCounts.get(current.name) || 0
      return currentCount < leastCount ? current : least
    })
  }
}
```

### 5.3 æ™ºèƒ½ä½“åä½œæ¡†æ¶

```typescript
// src/services/ai/AgentFramework.ts
export abstract class Agent {
  abstract name: string
  abstract description: string
  
  abstract async process(data: any, context: any): Promise<any>
  
  protected async callAI(prompt: string, context?: string): Promise<string> {
    const aiManager = new AIServiceManager()
    const response = await aiManager.callAI({ prompt, context })
    return response.content
  }
}

export class DataCollectionAgent extends Agent {
  name = 'æ•°æ®é‡‡é›†æ™ºèƒ½ä½“'
  description = 'è´Ÿè´£æ•°æ®è·å–ã€æ¸…æ´—å’Œé¢„å¤„ç†'
  
  async process(data: any, context: any): Promise<any> {
    // æ•°æ®æ¸…æ´—é€»è¾‘
    const cleanedData = await this.cleanData(data)
    
    // AIè¾…åŠ©æ•°æ®è´¨é‡è¯„ä¼°
    const qualityPrompt = `è¯·è¯„ä¼°ä»¥ä¸‹æ•°æ®çš„è´¨é‡ï¼š${JSON.stringify(cleanedData.sample)}`
    const qualityAssessment = await this.callAI(qualityPrompt)
    
    return {
      ...cleanedData,
      qualityScore: this.parseQualityScore(qualityAssessment),
      processingInfo: {
        agent: this.name,
        timestamp: new Date().toISOString(),
        recordsProcessed: cleanedData.records.length
      }
    }
  }
  
  private async cleanData(data: any): Promise<any> {
    // æ•°æ®æ¸…æ´—å®ç°
    return data
  }
  
  private parseQualityScore(assessment: string): number {
    // è§£æAIè¯„ä¼°ç»“æœ
    return 0.95
  }
}

export class PatternRecognitionAgent extends Agent {
  name = 'æ¨¡å¼è¯†åˆ«æ™ºèƒ½ä½“'
  description = 'è¯†åˆ«æ•°æ®ä¸­çš„æ¨¡å¼å’Œè¶‹åŠ¿'
  
  async process(data: any, context: any): Promise<any> {
    const patterns = await this.identifyPatterns(data)
    
    const patternPrompt = `
      åŸºäºä»¥ä¸‹æ•°æ®æ¨¡å¼ï¼Œè¯·åˆ†æä¸»è¦è¶‹åŠ¿ï¼š
      ${JSON.stringify(patterns)}
    `
    
    const trendAnalysis = await this.callAI(patternPrompt)
    
    return {
      ...data,
      patterns,
      trendAnalysis,
      processingInfo: {
        agent: this.name,
        timestamp: new Date().toISOString(),
        patternsFound: patterns.length
      }
    }
  }
  
  private async identifyPatterns(data: any): Promise<any[]> {
    // æ¨¡å¼è¯†åˆ«ç®—æ³•
    return []
  }
}

// å…¶ä»–æ™ºèƒ½ä½“ç±»ä¼¼å®ç°...

export class AgentOrchestrator {
  private agents: Agent[] = [
    new DataCollectionAgent(),
    new PatternRecognitionAgent(),
    new PredictiveModelingAgent(),
    new AnomalyDetectionAgent(),
    new ReportGenerationAgent()
  ]
  
  async executeAnalysis(data: any, context: any): Promise<any> {
    let result = data
    
    for (const agent of this.agents) {
      console.log(`æ‰§è¡Œ ${agent.name}...`)
      result = await agent.process(result, context)
      
      // æ›´æ–°è¿›åº¦
      await this.updateProgress(context.taskId, agent.name)
    }
    
    return result
  }
  
  private async updateProgress(taskId: string, agentName: string): Promise<void> {
    // æ›´æ–°ä»»åŠ¡è¿›åº¦
  }
}
```

## 6. å®‰å…¨æ¶æ„è®¾è®¡

### 6.1 è®¤è¯ä¸æˆæƒ

#### 6.1.1 JWTä»¤ç‰Œè®¾è®¡

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-uuid",
    "email": "user@example.com",
    "role": "analyst",
    "org_id": "org-uuid",
    "permissions": [
      "data:read",
      "analysis:create",
      "report:edit"
    ],
    "iat": 1642234567,
    "exp": 1642320967
  }
}
```

#### 6.1.2 æƒé™æ§åˆ¶çŸ©é˜µ

| è§’è‰² | æ•°æ®æºç®¡ç† | AIåˆ†æ | æŠ¥å‘Šç¼–è¾‘ | ç”¨æˆ·ç®¡ç† | ç³»ç»Ÿé…ç½® |
|------|------------|--------|----------|----------|----------|
| ç®¡ç†å‘˜ | âœ… | âœ… | âœ… | âœ… | âœ… |
| åˆ†æå¸ˆ | âœ… | âœ… | âœ… | âŒ | âŒ |
| æŸ¥çœ‹è€… | ğŸ‘ï¸ | ğŸ‘ï¸ | ğŸ‘ï¸ | âŒ | âŒ |
| è®¿å®¢ | âŒ | âŒ | ğŸ‘ï¸ | âŒ | âŒ |

### 6.2 æ•°æ®å®‰å…¨

#### 6.2.1 æ•æ„Ÿæ•°æ®å¤„ç†

```typescript
// src/utils/security.ts
export class DataSecurity {
  // æ•°æ®è„±æ•
  static maskSensitiveData(data: any, fields: string[]): any {
    const masked = { ...data }
    
    fields.forEach(field => {
      if (masked[field]) {
        masked[field] = this.maskValue(masked[field])
      }
    })
    
    return masked
  }
  
  private static maskValue(value: string): string {
    if (value.length <= 4) return '***'
    return value.substring(0, 2) + '*'.repeat(value.length - 4) + value.substring(value.length - 2)
  }
  
  // APIå¯†é’¥åŠ å¯†
  static encryptApiKey(apiKey: string): string {
    // ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å¯†é’¥è¿›è¡ŒåŠ å¯†
    return encrypt(apiKey, process.env.ENCRYPTION_KEY!)
  }
  
  static decryptApiKey(encryptedKey: string): string {
    return decrypt(encryptedKey, process.env.ENCRYPTION_KEY!)
  }
}
```

### 6.3 APIå®‰å…¨

#### 6.3.1 è¯·æ±‚é™æµ

```typescript
// src/middleware/rateLimit.ts
export class RateLimiter {
  private static requests: Map<string, number[]> = new Map()
  
  static checkLimit(userId: string, limit: number = 100, window: number = 3600): boolean {
    const now = Date.now()
    const userRequests = this.requests.get(userId) || []
    
    // æ¸…ç†è¿‡æœŸè¯·æ±‚
    const validRequests = userRequests.filter(time => now - time < window * 1000)
    
    if (validRequests.length >= limit) {
      return false
    }
    
    validRequests.push(now)
    this.requests.set(userId, validRequests)
    
    return true
  }
}
```

## 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 ç¼“å­˜ç­–ç•¥

#### 7.1.1 å¤šå±‚ç¼“å­˜æ¶æ„

```typescript
// src/services/cache/CacheManager.ts
export class CacheManager {
  private memoryCache: Map<string, any> = new Map()
  private redisClient: any // Rediså®¢æˆ·ç«¯
  
  async get(key: string): Promise<any> {
    // L1: å†…å­˜ç¼“å­˜
    if (this.memoryCache.has(key)) {
      return this.memoryCache.get(key)
    }
    
    // L2: Redisç¼“å­˜
    const redisValue = await this.redisClient.get(key)
    if (redisValue) {
      const parsed = JSON.parse(redisValue)
      this.memoryCache.set(key, parsed)
      return parsed
    }
    
    return null
  }
  
  async set(key: string, value: any, ttl: number = 3600): Promise<void> {
    // è®¾ç½®å†…å­˜ç¼“å­˜
    this.memoryCache.set(key, value)
    
    // è®¾ç½®Redisç¼“å­˜
    await this.redisClient.setex(key, ttl, JSON.stringify(value))
  }
}
```

### 7.2 æ•°æ®åº“ä¼˜åŒ–

#### 7.2.1 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
CREATE OR REPLACE FUNCTION get_analysis_tasks_paginated(
    user_id UUID,
    page_size INTEGER DEFAULT 20,
    page_offset INTEGER DEFAULT 0
)
RETURNS TABLE (
    id UUID,
    name VARCHAR,
    status VARCHAR,
    created_at TIMESTAMP WITH TIME ZONE,
    total_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        t.id,
        t.name,
        t.status,
        t.created_at,
        COUNT(*) OVER() as total_count
    FROM analysis_tasks t
    WHERE t.owner_id = user_id
    ORDER BY t.created_at DESC
    LIMIT page_size
    OFFSET page_offset;
END;
$$ LANGUAGE plpgsql;
```

### 7.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### 7.3.1 ä»£ç åˆ†å‰²

```typescript
// src/router/index.tsx
import { lazy, Suspense } from 'react'
import { createBrowserRouter } from 'react-router-dom'

// æ‡’åŠ è½½ç»„ä»¶
const Dashboard = lazy(() => import('../pages/Dashboard'))
const AIAnalysis = lazy(() => import('../pages/AIAnalysis'))
const ReportEditor = lazy(() => import('../pages/ReportEditor'))

export const router = createBrowserRouter([
  {
    path: '/',
    element: (
      <Suspense fallback={<div>Loading...</div>}>
        <MainLayout />
      </Suspense>
    ),
    children: [
      {
        path: 'dashboard',
        element: (
          <Suspense fallback={<div>Loading Dashboard...</div>}>
            <Dashboard />
          </Suspense>
        )
      }
      // å…¶ä»–è·¯ç”±...
    ]
  }
])
```

## 8. ç›‘æ§ä¸è¿ç»´

### 8.1 ç³»ç»Ÿç›‘æ§

#### 8.1.1 ç›‘æ§æŒ‡æ ‡

```typescript
// src/services/monitoring/MetricsCollector.ts
export class MetricsCollector {
  private metrics: Map<string, number> = new Map()
  
  // è®°å½•APIå“åº”æ—¶é—´
  recordApiResponseTime(endpoint: string, duration: number): void {
    const key = `api.response_time.${endpoint}`
    this.metrics.set(key, duration)
  }
  
  // è®°å½•AIæœåŠ¡è°ƒç”¨
  recordAIServiceCall(provider: string, success: boolean): void {
    const successKey = `ai.${provider}.success`
    const failureKey = `ai.${provider}.failure`
    
    if (success) {
      this.incrementCounter(successKey)
    } else {
      this.incrementCounter(failureKey)
    }
  }
  
  // è®°å½•ç”¨æˆ·æ´»åŠ¨
  recordUserActivity(userId: string, action: string): void {
    const key = `user.activity.${action}`
    this.incrementCounter(key)
  }
  
  private incrementCounter(key: string): void {
    const current = this.metrics.get(key) || 0
    this.metrics.set(key, current + 1)
  }
}
```

### 8.2 æ—¥å¿—ç®¡ç†

#### 8.2.1 ç»“æ„åŒ–æ—¥å¿—

```typescript
// src/utils/logger.ts
export class Logger {
  static info(message: string, metadata?: any): void {
    this.log('info', message, metadata)
  }
  
  static warn(message: string, metadata?: any): void {
    this.log('warn', message, metadata)
  }
  
  static error(message: string, error?: Error, metadata?: any): void {
    this.log('error', message, { ...metadata, error: error?.stack })
  }
  
  private static log(level: string, message: string, metadata?: any): void {
    const logEntry = {
      timestamp: new Date().toISOString(),
      level,
      message,
      service: 'smart-report-frontend',
      ...metadata
    }
    
    console.log(JSON.stringify(logEntry))
    
    // å‘é€åˆ°åç«¯æ—¥å¿—ç³»ç»Ÿ
    this.sendToBackend(logEntry)
  }
  
  private static async sendToBackend(logEntry: any): Promise<void> {
    try {
      await fetch('/api/logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(logEntry)
      })
    } catch (error) {
      // é™é»˜å¤„ç†æ—¥å¿—å‘é€å¤±è´¥
    }
  }
}
```

## 9. éƒ¨ç½²æ¶æ„

### 9.1 å®¹å™¨åŒ–éƒ¨ç½²

#### 9.1.1 Dockerfile

```dockerfile
# å‰ç«¯Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 9.2 CI/CDæµç¨‹

#### 9.2.1 GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build application
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    - name: Deploy to Vercel
      uses: vercel/action@v1
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024å¹´1æœˆ  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´1æœˆ  
**è´Ÿè´£äºº**: æŠ€æœ¯æ¶æ„å¸ˆ  
**å®¡æ ¸äºº**: CTOã€æŠ€æœ¯è´Ÿè´£äºº